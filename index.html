<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifqyURL | Enterprise v7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            background-color: #020617; 
            color: #f8fafc; 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .input-field {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.4);
            transition: all 0.3s ease;
        }
        .input-field:focus {
            background: rgba(30, 41, 59, 0.9);
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }
        /* Custom Checkbox UI */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-4 min-h-screen relative">

    <div class="fixed top-20 left-10 w-72 h-72 bg-blue-500/10 rounded-full blur-[100px] pointer-events-none"></div>
    <div class="fixed bottom-20 right-10 w-72 h-72 bg-purple-500/10 rounded-full blur-[100px] pointer-events-none"></div>

    <div id="creatorApp" class="w-full max-w-xl glass-card p-8 rounded-3xl relative z-10 fade-in" style="animation-delay: 0.1s;">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-white tracking-tight mb-2">Rifqy<span class="text-blue-500">URL</span></h1>
            <div class="flex justify-center gap-2">
                <span class="px-2 py-0.5 rounded-full bg-blue-500/10 text-blue-400 text-[10px] font-bold border border-blue-500/20">ENTERPRISE v7</span>
                <span class="px-2 py-0.5 rounded-full bg-purple-500/10 text-purple-400 text-[10px] font-bold border border-purple-500/20">SECURE</span>
            </div>
        </div>

        <div class="space-y-5">
            <div class="group">
                <label class="block text-[10px] font-bold text-slate-400 mb-1.5 ml-1 uppercase">URL Tujuan (Pisahkan koma untuk Rotator)</label>
                <div class="relative">
                    <i class="fa-solid fa-link absolute left-4 top-4 text-slate-500"></i>
                    <input type="text" id="longUrl" placeholder="https://site1.com, https://site2.com" class="input-field w-full pl-10 pr-4 py-3.5 rounded-xl outline-none text-sm text-white placeholder-slate-600">
                </div>
                <p class="text-[10px] text-slate-500 mt-1 ml-1">*Contoh Rotator: https://google.com, https://youtube.com</p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1.5 ml-1 uppercase">Custom Alias</label>
                    <input type="text" id="customId" placeholder="nama-keren" class="input-field w-full px-4 py-3 rounded-xl outline-none text-sm text-white placeholder-slate-600">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 mb-1.5 ml-1 uppercase">Durasi Link</label>
                    <select id="expiryTime" class="input-field w-full px-4 py-3 rounded-xl outline-none text-sm text-slate-300 cursor-pointer">
                        <option value="86400000">24 Jam</option>
                        <option value="604800000" selected>7 Hari</option>
                        <option value="2592000000">30 Hari</option>
                        <option value="premium">‚ú® Permanen (Premium)</option>
                    </select>
                </div>
            </div>

            <div class="border-t border-slate-700/50 pt-4">
                <button onclick="document.getElementById('advOptions').classList.toggle('hidden')" class="text-xs text-blue-400 font-bold hover:text-blue-300 flex items-center gap-1">
                    <i class="fa-solid fa-gear"></i> Pengaturan Canggih
                </button>
                
                <div id="advOptions" class="hidden mt-4 space-y-4 bg-slate-900/40 p-4 rounded-xl border border-slate-700/30">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Password Link</label>
                            <input type="text" id="linkPassword" placeholder="(Opsional)" class="input-field w-full px-3 py-2 rounded-lg text-xs">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase">Max Klik (Limit)</label>
                            <input type="number" id="maxClicks" placeholder="0 = Unlimited" class="input-field w-full px-3 py-2 rounded-lg text-xs">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase"><i class="fa-regular fa-clock"></i> Jam Operasional (WIB/Lokal)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="time" id="timeStart" class="input-field w-full px-3 py-2 rounded-lg text-xs text-white">
                            <input type="time" id="timeEnd" class="input-field w-full px-3 py-2 rounded-lg text-xs text-white">
                        </div>
                        <p class="text-[9px] text-slate-500 mt-1">*Link hanya bisa dibuka di antara jam ini. Kosongkan jika 24 jam.</p>
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1 uppercase"><i class="fa-solid fa-earth-asia"></i> Filter Negara (Kode ISO)</label>
                        <input type="text" id="geoBlock" placeholder="Contoh: ID, MY, US (Pisahkan koma)" class="input-field w-full px-3 py-2 rounded-lg text-xs uppercase mb-2">
                        
                        <div class="flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg border border-slate-700/50">
                            <input type="checkbox" id="isWhitelist" class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500">
                            <label for="isWhitelist" class="text-[10px] font-bold text-slate-300 cursor-pointer select-none">
                                Mode Whitelist (Hanya Izinkan Negara di atas)
                            </label>
                        </div>
                        <p class="text-[9px] text-slate-500 mt-1 ml-1">Default: Kosong = Semua negara diizinkan.</p>
                    </div>
                </div>
            </div>

            <button onclick="shorten()" id="btnShorten" class="btn-primary w-full text-white font-bold py-4 rounded-xl transition-all active:scale-[0.98] flex justify-center items-center gap-2">
                Buat Link Sekarang <i class="fa-solid fa-bolt"></i>
            </button>
        </div>

        <div id="resultArea" class="hidden mt-6 pt-6 border-t border-slate-700/50 fade-in">
            <div class="flex flex-col items-center gap-4">
                <div class="bg-white p-2 rounded-xl shadow-lg">
                    <img id="qrImage" src="" alt="QR" class="w-24 h-24 object-contain">
                </div>
                <div class="w-full flex gap-2 bg-slate-900/80 p-3 rounded-xl border border-slate-700">
                    <p id="shortLink" class="flex-1 text-blue-400 font-mono text-sm truncate flex items-center"></p>
                    <button onclick="copyLink()" class="bg-slate-800 hover:bg-slate-700 text-white text-xs px-4 rounded-lg font-bold transition-colors">Salin</button>
                </div>
            </div>
        </div>
    </div>

    <div id="previewApp" class="hidden w-full max-w-md glass-card p-8 rounded-3xl text-center fade-in">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/20">
            <i class="fa-solid fa-shield-halved text-2xl text-white"></i>
        </div>
        
        <h2 id="prevTitle" class="text-2xl font-bold text-white mb-2">Pemeriksaan Keamanan</h2>
        <p id="prevDesc" class="text-slate-400 text-sm mb-6">Link ini dilindungi oleh sistem RifqyURL.</p>

        <div id="dynamicContent" class="mb-6">
            <div id="passArea" class="hidden">
                <input type="password" id="inputPass" placeholder="Masukkan Password Link" class="input-field w-full px-4 py-3 rounded-xl text-center text-white mb-2">
                <p id="passError" class="text-xs text-red-500 hidden font-bold">Password Salah!</p>
            </div>
            <button onclick="reportLink()" id="btnReport" class="text-[10px] text-slate-500 hover:text-red-400 flex items-center justify-center gap-1 w-full mt-2 transition-colors">
                <i class="fa-solid fa-flag"></i> Laporkan Link Ini
            </button>
        </div>

        <button id="btnContinue" class="btn-primary w-full text-white font-bold py-3.5 rounded-xl transition-all shadow-lg">
            Lanjut ke Tujuan <i class="fa-solid fa-arrow-right ml-1"></i>
        </button>
    </div>

    <div id="errorApp" class="hidden text-center fade-in">
        <div class="text-6xl mb-4">‚õî</div>
        <h1 id="errorTitle" class="text-3xl font-extrabold text-white mb-2">Akses Ditolak</h1>
        <p id="errorDesc" class="text-slate-400 text-sm mb-8 max-w-xs mx-auto">Link tidak dapat diakses saat ini.</p>
        <a href="/" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold transition-all border border-slate-600">
            Buat Link Baru
        </a>
    </div>

    <div id="adminPanel" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-4xl glass-card rounded-2xl h-[80vh] flex flex-col">
            <div class="p-6 border-b border-slate-700/50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white">Admin Dashboard</h2>
                    <p class="text-xs text-slate-400">Monitoring & Analytics Real-time</p>
                </div>
                <button onclick="document.getElementById('adminPanel').classList.add('hidden')" class="bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition">Close</button>
            </div>
            <div class="flex-1 overflow-auto p-6">
                <div class="grid grid-cols-12 gap-2 text-[10px] font-bold text-slate-500 uppercase mb-3 px-2">
                    <div class="col-span-2">Alias</div>
                    <div class="col-span-1 text-center">Klik</div>
                    <div class="col-span-2 text-center">Info</div>
                    <div class="col-span-5">Target URL</div>
                    <div class="col-span-2 text-right">Status</div>
                </div>
                <div id="adminList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div onclick="unlockAdmin()" class="mt-8 text-slate-800 text-[10px] cursor-pointer hover:text-slate-600 select-none">v7.0-ultimate</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, remove, update, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyChF12-MFH4BMTE9p2HGypUhvFYSDlilbc",
            authDomain: "rifqyurl.firebaseapp.com",
            projectId: "rifqyurl",
            databaseURL: "https://rifqyurl-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "rifqyurl.firebasestorage.app",
            messagingSenderId: "772691101649",
            appId: "1:772691101649:web:a856d7e9bea45ba04502f0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- HELPER FUNCTIONS ---
        async function getIP() {
            try { const res = await fetch('https://api.ipify.org?format=json'); const data = await res.json(); return data.ip.replace(/\./g, "_"); } 
            catch (e) { return "unknown_ip"; }
        }
        async function getGeo() {
            try { const res = await fetch('https://ipapi.co/json/'); const data = await res.json(); return data.country_code; } 
            catch (e) { return "XX"; }
        }
        function isBot() { return /googlebot|bot|crawler|spider|robot|crawling/i.test(navigator.userAgent); }
        function getDeviceType() { return /mobile|android|iphone/i.test(navigator.userAgent) ? "mobile" : "desktop"; }

        // --- 1. CORE SHORTENER LOGIC ---
        window.shorten = async function() {
            const longUrlInput = document.getElementById('longUrl').value.trim();
            const customId = document.getElementById('customId').value.trim().replace(/[^a-zA-Z0-9-_]/g, '');
            const expiryVal = document.getElementById('expiryTime').value;
            const linkPass = document.getElementById('linkPassword').value.trim();
            const maxClicksInput = document.getElementById('maxClicks').value;
            
            // New Features Inputs
            const geoBlockInput = document.getElementById('geoBlock').value.toUpperCase();
            const isWhitelist = document.getElementById('isWhitelist').checked;
            const timeStart = document.getElementById('timeStart').value;
            const timeEnd = document.getElementById('timeEnd').value;
            
            const btn = document.getElementById('btnShorten');

            if (!longUrlInput) return alert("Masukkan URL!");
            const urls = longUrlInput.split(',').map(u => u.trim()).filter(u => u.startsWith('http'));
            if (urls.length === 0) return alert("URL harus diawali https://");

            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Memproses...`;

            try {
                // IP Limit
                const ip = await getIP();
                const limitRef = ref(db, 'user_limits/' + ip);
                const snapshot = await get(limitRef);
                const SEVEN_DAYS = 604800000;
                let userData = snapshot.val() || { count: 0, startTime: Date.now() };

                if (Date.now() - userData.startTime > SEVEN_DAYS) userData = { count: 0, startTime: Date.now() };
                if (userData.count >= 5) throw new Error("Limit 5 Link/Minggu tercapai!");

                // Premium
                let isPremium = false;
                let expiryTime = Date.now() + parseInt(expiryVal);
                if (expiryVal === "premium") {
                    if (prompt("Password Owner:") !== "RifqyQPP28!@") throw new Error("Akses Ditolak");
                    isPremium = true; expiryTime = 32503680000000;
                }

                // Anti-Collision
                const shortId = customId || Math.random().toString(36).substring(2, 8);
                const check = await get(ref(db, 'links/' + shortId));
                if (check.exists()) throw new Error("Alias sudah dipakai!");

                // Geo List Processing
                const countryList = geoBlockInput.split(',').map(c => c.trim()).filter(c => c.length === 2);

                // Save
                await set(ref(db, 'links/' + shortId), {
                    urls: urls,
                    rotatorIndex: 0,
                    createdAt: Date.now(),
                    expiry: expiryTime,
                    isPremium: isPremium,
                    ip: ip,
                    password: linkPass || null,
                    maxClicks: parseInt(maxClicksInput) || 0,
                    
                    // NEW FEATURES DATA
                    countries: countryList,     // List negara
                    whitelistMode: isWhitelist, // True = Whitelist, False = Blacklist
                    schedule: { start: timeStart, end: timeEnd }, // Jam Operasional
                    
                    clicks: 0,
                    stats: { mobile: 0, desktop: 0 },
                    isReported: false
                });

                userData.count++;
                await set(limitRef, userData);

                const resultLink = window.location.origin + window.location.pathname + "?id=" + shortId;
                document.getElementById('shortLink').innerText = resultLink;
                document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(resultLink)}`;
                document.getElementById('resultArea').classList.remove('hidden');
                document.getElementById('longUrl').value = ""; document.getElementById('customId').value = "";

            } catch (e) { alert(e.message); } 
            finally { btn.disabled = false; btn.innerHTML = `Buat Link Sekarang <i class="fa-solid fa-bolt"></i>`; }
        };

        // --- 2. ACCESS LOGIC (UPDATED) ---
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        if (id) {
            document.getElementById('creatorApp').style.display = 'none';
            document.body.insertAdjacentHTML('beforeend', `<div id="loader" class="text-blue-400 font-bold animate-pulse text-xl"><i class="fa-solid fa-satellite-dish fa-spin"></i> Checking...</div>`);
            initRedirect();
        }

        async function initRedirect() {
            if (isBot()) { document.getElementById('loader').remove(); return showError("Bot Detected", "Akses ditolak untuk bot."); }

            const snap = await get(ref(db, 'links/' + id));
            document.getElementById('loader')?.remove();

            if (!snap.exists()) return showError("404", "Link tidak ditemukan.");
            const data = snap.val();

            // 1. Basic Checks
            if (data.isReported) return showError("Bahaya", "Link ini telah dilaporkan.");
            if (Date.now() > data.expiry) { await remove(ref(db, 'links/' + id)); return showError("Kadaluarsa", "Link sudah expired."); }
            if (data.maxClicks > 0 && data.clicks >= data.maxClicks) return showError("Limit Tercapai", "Link mencapai batas klik.");

            // 2. SCHEDULE CHECK (NEW)
            if (data.schedule && data.schedule.start && data.schedule.end) {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMin = now.getMinutes();
                const currentTime = currentHour * 60 + currentMin; // Convert to minutes

                const [sh, sm] = data.schedule.start.split(':').map(Number);
                const [eh, em] = data.schedule.end.split(':').map(Number);
                const startTime = sh * 60 + sm;
                const endTime = eh * 60 + em;

                // Simple range check
                if (currentTime < startTime || currentTime > endTime) {
                    return showError("Tutup", `Link hanya aktif pukul ${data.schedule.start} - ${data.schedule.end}`);
                }
            }

            // 3. GEO CHECK (WHITELIST/BLACKLIST) (NEW)
            if (data.countries && data.countries.length > 0) {
                const userCountry = await getGeo();
                
                if (data.whitelistMode) {
                    // WHITELIST MODE: Jika negara user TIDAK ada di list -> Blokir
                    if (!data.countries.includes(userCountry)) {
                        return showError("Akses Dibatasi", `Maaf, link ini khusus untuk negara: ${data.countries.join(', ')}`);
                    }
                } else {
                    // BLACKLIST MODE: Jika negara user ADA di list -> Blokir
                    if (data.countries.includes(userCountry)) {
                        return showError("Akses Ditolak", `Negara Anda (${userCountry}) diblokir oleh pembuat link.`);
                    }
                }
            }

            // --- Show Preview ---
            const prevApp = document.getElementById('previewApp');
            prevApp.classList.remove('hidden');
            const btnContinue = document.getElementById('btnContinue');

            if (data.password) {
                document.getElementById('prevTitle').innerText = "Link Terkunci";
                document.getElementById('passArea').classList.remove('hidden');
                btnContinue.innerText = "Buka Kunci üîì";
                btnContinue.onclick = () => {
                    if (document.getElementById('inputPass').value === data.password) processRedirect(data);
                    else document.getElementById('passError').classList.remove('hidden');
                };
            } else {
                btnContinue.onclick = () => processRedirect(data);
            }
        }

        async function processRedirect(data) {
            const btn = document.getElementById('btnContinue');
            btn.disabled = true;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Mengalihkan...`;

            const updates = {};
            updates['clicks'] = increment(1);
            updates[`stats/${getDeviceType()}`] = increment(1);
            
            let targetUrl = "";
            if (Array.isArray(data.urls) && data.urls.length > 1) {
                const nextIndex = (data.rotatorIndex + 1) % data.urls.length;
                targetUrl = data.urls[data.rotatorIndex];
                updates['rotatorIndex'] = nextIndex;
            } else {
                targetUrl = Array.isArray(data.urls) ? data.urls[0] : data.urls;
            }

            await update(ref(db, 'links/' + id), updates);
            window.location.href = targetUrl;
        }

        window.reportLink = async () => {
            if(confirm("Laporkan link ini?")) {
                await update(ref(db, 'links/' + id), { isReported: true });
                location.reload();
            }
        };

        function showError(title, msg) {
            document.getElementById('errorApp').classList.remove('hidden');
            document.getElementById('errorTitle').innerText = title;
            document.getElementById('errorDesc').innerText = msg;
        }

        // --- 3. ADMIN ---
        let taps = 0;
        window.unlockAdmin = () => { if (++taps >= 5) { if (prompt("Key:") === "RifqyQPP28!@") renderAdmin(); taps = 0; } };

        async function renderAdmin() {
            document.getElementById('adminPanel').classList.remove('hidden');
            const list = document.getElementById('adminList');
            const snap = await get(ref(db, 'links'));
            let html = "";
            
            snap.forEach(child => {
                const d = child.val();
                let badges = "";
                if (d.whitelistMode) badges += "<span class='text-green-400'>[WL]</span> ";
                else if (d.countries) badges += "<span class='text-red-400'>[BL]</span> ";
                if (d.schedule && d.schedule.start) badges += "‚è∞ ";
                if (d.isReported) badges += "‚õî ";

                html += `<div class="grid grid-cols-12 gap-2 p-3 bg-slate-800/50 rounded-xl border border-slate-700 items-center text-[10px] hover:bg-slate-800 transition">
                    <div class="col-span-2 font-mono font-bold text-blue-400 truncate">${child.key}</div>
                    <div class="col-span-1 text-center text-white bg-slate-700 rounded">${d.clicks}</div>
                    <div class="col-span-2 text-center text-xs">${badges}</div>
                    <div class="col-span-5 truncate text-slate-300">${Array.isArray(d.urls) ? d.urls[0] : d.url}</div>
                    <div class="col-span-2 text-right"><button onclick="del('${child.key}')" class="text-red-500 hover:bg-red-500/10 p-1 rounded"><i class="fa-solid fa-trash"></i></button></div>
                </div>`;
            });
            list.innerHTML = html || "<p class='text-center py-4'>Kosong</p>";
        }
        window.del = async (k) => { if(confirm("Hapus?")) { await remove(ref(db, 'links/'+k)); renderAdmin(); } };
        window.copyLink = () => { navigator.clipboard.writeText(document.getElementById('shortLink').innerText); alert("Salin!"); };
    </script>
</body>
</html>
