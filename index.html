<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RifqyURL v10 - Ultimate Shortener</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #00ff88;
            --secondary: #00ccff;
            --bg: #0a0a12;
            --card: #161622;
            --text: #e0e0e0;
            --error: #ff4d4d;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Rajdhani', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow-x: hidden;
            user-select: none; /* Anti-Block Select */
        }

        /* Anti-Inspect Overlay */
        #inspect-shield {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; display: none;
            justify-content: center; align-items: center; color: red; font-size: 2rem;
            text-align: center;
        }

        /* Navbar */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: rgba(22, 22, 34, 0.9);
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
            backdrop-filter: blur(10px);
        }
        .logo { font-size: 24px; font-weight: 700; color: var(--primary); text-shadow: 0 0 10px var(--primary); }
        .user-info { display: flex; gap: 10px; align-items: center; }
        .btn-auth {
            background: transparent; border: 1px solid var(--secondary);
            color: var(--secondary); padding: 5px 15px; border-radius: 5px;
            cursor: pointer; font-family: inherit; font-weight: 600;
            transition: 0.3s;
        }
        .btn-auth:hover { background: var(--secondary); color: #000; box-shadow: 0 0 15px var(--secondary); }

        /* Container */
        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* Cards */
        .card {
            background: var(--card); border-radius: 12px; padding: 25px;
            margin-bottom: 20px; border: 1px solid #333;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .card h2 { margin-top: 0; color: var(--primary); border-bottom: 1px solid #333; padding-bottom: 10px; }

        /* Form Elements */
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 12px; background: #0f0f18; border: 1px solid #333;
            color: #fff; border-radius: 6px; font-family: inherit; font-size: 1rem;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 255, 136, 0.2); }
        
        /* Alias Checker Status */
        .status-msg { font-size: 0.8rem; margin-top: 5px; display: none; }
        .status-ok { color: var(--primary); }
        .status-err { color: var(--error); }

        /* Buttons */
        .btn-main {
            width: 100%; padding: 15px; background: linear-gradient(45deg, var(--primary), #00aa55);
            border: none; color: #000; font-weight: 800; font-size: 1.1rem;
            border-radius: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3); transition: 0.3s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0, 255, 136, 0.5); }
        .btn-main:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }

        /* Dashboard Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; font-size: 0.9rem; }
        th { color: var(--secondary); }
        .action-btn { cursor: pointer; padding: 5px; margin-right: 5px; }
        .icon-qr { color: var(--primary); }
        .icon-del { color: var(--error); }

        /* Result Box */
        #result-box { display: none; text-align: center; margin-top: 20px; padding: 20px; background: #1a1a2e; border: 1px solid var(--primary); border-radius: 8px; }
        .short-link { font-size: 1.5rem; color: var(--secondary); word-break: break-all; margin: 10px 0; }
        
        /* Quota Bar */
        .quota-container { background: #333; height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .quota-fill { height: 100%; background: var(--secondary); width: 0%; transition: 1s; }
        .quota-text { font-size: 0.8rem; text-align: right; color: #888; }

        /* Tab System */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; background: #161622; border: 1px solid #333; color: #888; cursor: pointer; text-align: center; border-radius: 5px; }
        .tab-btn.active { background: var(--secondary); color: #000; font-weight: bold; border-color: var(--secondary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal QR */
        #qr-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        #qr-display { background: white; padding: 20px; border-radius: 10px; }
        .close-modal { margin-top: 20px; color: white; cursor: pointer; font-size: 1.2rem; }

        /* Footer */
        .footer { text-align: center; padding: 20px; color: #555; font-size: 0.8rem; margin-top: 30px; }
    </style>
</head>
<body oncontextmenu="return false" onkeydown="return disableInspect(event)">

    <div id="inspect-shield">
        <div>
            <i class="fas fa-user-secret fa-3x"></i><br>
            AKSES DITOLAK!<br>
            <span style="font-size: 1rem; color: white;">RifqyURL v10 Protected</span>
        </div>
    </div>

    <nav class="navbar">
        <div class="logo"><i class="fas fa-link"></i> RifqyURL v10</div>
        <div class="user-info">
            <span id="user-display" style="font-size: 0.9rem;">Guest</span>
            <button id="auth-btn" class="btn-auth" onclick="toggleAuth()">Login Google</button>
        </div>
    </nav>

    <div class="container">
        
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('create')">Buat Link</div>
            <div class="tab-btn" onclick="switchTab('dashboard')" id="tab-dash">Dashboard</div>
            <div class="tab-btn" onclick="switchTab('admin')" id="tab-admin" style="display:none;">Admin Area</div>
        </div>

        <div id="view-create" class="tab-content active">
            <div class="card">
                <h2><i class="fas fa-plus-circle"></i> Buat Link Baru</h2>
                
                <div class="quota-text" id="quota-msg">Memuat data kuota...</div>
                <div class="quota-container">
                    <div class="quota-fill" id="quota-bar"></div>
                </div>

                <div class="form-group">
                    <label>Link Asli (Tujuan)</label>
                    <input type="url" id="ori-url" placeholder="https://youtube.com/..." required>
                </div>

                <div class="form-group">
                    <label>Custom Alias (Wajib)</label>
                    <input type="text" id="alias-input" placeholder="contoh: mabar" onkeyup="checkAlias()" onkeypress="return blockSpaces(event)">
                    <div id="alias-status" class="status-msg"></div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>Password (Opsional)</label>
                        <input type="text" id="pass-input" placeholder="Kunci Link">
                    </div>
                    <div class="form-group">
                        <label>Hint Password</label>
                        <input type="text" id="hint-input" placeholder="Contoh: Tgl Lahir">
                    </div>
                </div>

                <div class="form-group">
                    <label>Link Cadangan (Jika Limit Habis/Expired)</label>
                    <input type="url" id="backup-url" placeholder="https://...">
                    <small style="color: #666; font-size: 0.7rem;">*User akan dialihkan kesini jika link utama mati.</small>
                </div>

                <button class="btn-main" id="btn-create" onclick="createLink()">Generate Link <i class="fas fa-rocket"></i></button>

                <div id="result-box">
                    <p>Link Berhasil Dibuat:</p>
                    <div class="short-link" id="final-link">...</div>
                    <button class="btn-auth" onclick="copyLink()">Salin</button>
                    <button class="btn-auth" onclick="showQR(document.getElementById('final-link').innerText)">QR Code</button>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> Client Dashboard</h2>
                <p>Kelola link yang sudah kamu buat.</p>
                <div class="table-responsive">
                    <table id="client-table">
                        <thead>
                            <tr>
                                <th>Alias</th>
                                <th>Klik</th>
                                <th>Limit</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-admin" class="tab-content">
            <div class="card" style="border-color: var(--error);">
                <h2 style="color: var(--error);"><i class="fas fa-user-shield"></i> Admin God Mode</h2>
                <div class="form-group">
                    <input type="text" id="ban-ip-input" placeholder="Masukkan IP untuk di-Banned">
                    <button onclick="banIP()" style="background: var(--error); color: white; padding: 5px; border: none; margin-top: 5px;">BAN IP NOW</button>
                </div>
                <hr style="border-color: #333;">
                <h3>Semua Link Database</h3>
                <div class="table-responsive">
                    <table id="admin-table">
                        <thead>
                            <tr>
                                <th>Owner</th>
                                <th>Alias</th>
                                <th>Tujuan</th>
                                <th>Hapus</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="qr-modal">
        <div id="qr-display"></div>
        <div class="close-modal" onclick="closeQR()">Tutup [X]</div>
    </div>

    <div class="footer">
        &copy; 2024 RifqyURL v10 Ultimate. All Rights Reserved.
    </div>

    <script>
        // =========================================================
        // 1. FIREBASE CONFIGURATION (ISI DENGAN DATA KAMU)
        // =========================================================
        const firebaseConfig = {
            apiKey: "ISI_API_KEY_DISINI",
            authDomain: "ISI_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://ISI_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "ISI_PROJECT_ID",
            storageBucket: "ISI_PROJECT_ID.appspot.com",
            messagingSenderId: "ISI_SENDER_ID",
            appId: "ISI_APP_ID"
        };

        // GANTI EMAIL INI DENGAN EMAIL KAMU UNTUK AKSES ADMIN
        const ADMIN_EMAIL = "rifqy@gmail.com"; 

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();

        // Variables
        let currentUser = null;
        let userIP = "loading";
        let isIPBanned = false;

        // =========================================================
        // 2. SECURITY & SYSTEM INIT
        // =========================================================
        
        // Anti-Inspect Logic
        function disableInspect(e) {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 'Shift')) return false;
            if (e.keyCode === 123) return false; // F12
        }
        document.addEventListener('contextmenu', event => event.preventDefault());

        // Get IP & Init
        async function initSystem() {
            try {
                // Get IP
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                userIP = sanitizeKey(data.ip);
                
                // Check Ban Status
                const banRef = await db.ref('banned_ips/' + userIP).once('value');
                if (banRef.exists()) {
                    document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:50px;'>AKSES DIBLOKIR ADMIN!</h1>";
                    return;
                }

                // Load Stats
                loadQuota();
                
            } catch (e) {
                console.log("IP Check Error (Offline?)");
            }
        }

        // Auth Observer
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('user-display').innerText = user.displayName || user.email;
                document.getElementById('auth-btn').innerText = "Logout";
                document.getElementById('auth-btn').setAttribute('onclick', 'logout()');
                
                // Show Admin Tab if owner
                if(user.email === ADMIN_EMAIL) {
                    document.getElementById('tab-admin').style.display = 'block';
                    loadAdminData();
                }

                // Load Client Data
                loadClientData();
            } else {
                document.getElementById('user-display').innerText = "Guest (Anonymous)";
                document.getElementById('auth-btn').innerText = "Login Google";
                document.getElementById('auth-btn').setAttribute('onclick', 'toggleAuth()');
                document.getElementById('tab-admin').style.display = 'none';
                document.getElementById('client-table').querySelector('tbody').innerHTML = '<tr><td colspan="4">Login untuk melihat data.</td></tr>';
            }
            loadQuota();
        });

        // =========================================================
        // 3. CORE FUNCTIONS (CREATE & CHECK)
        // =========================================================

        function sanitizeKey(key) {
            // Mengubah . dan : menjadi _ agar valid di Firebase Key (Fix Limit 10x IPv6)
            return key.replace(/\./g, '_').replace(/:/g, '_');
        }

        function blockSpaces(e) {
            if (e.which === 32) return false;
        }

        async function checkAlias() {
            const alias = document.getElementById('alias-input').value.trim();
            const btn = document.getElementById('btn-create');
            const status = document.getElementById('alias-status');

            if (alias.length < 3) {
                status.style.display = 'none';
                return;
            }

            status.style.display = 'block';
            status.innerText = "Memeriksa...";
            status.className = "status-msg";

            const snapshot = await db.ref('links/' + alias).once('value');
            if (snapshot.exists()) {
                status.innerText = "Alias sudah dipakai! ❌";
                status.className = "status-msg status-err";
                btn.disabled = true;
            } else {
                status.innerText = "Alias tersedia ✅";
                status.className = "status-msg status-ok";
                btn.disabled = false;
            }
        }

        async function createLink() {
            const alias = document.getElementById('alias-input').value.trim();
            const oriUrl = document.getElementById('ori-url').value.trim();
            const pass = document.getElementById('pass-input').value.trim();
            const hint = document.getElementById('hint-input').value.trim();
            const backup = document.getElementById('backup-url').value.trim();

            if (!alias || !oriUrl) { alert("Alias dan URL Asli wajib diisi!"); return; }

            // Quota Check
            const isLogin = !!currentUser;
            const maxLimit = isLogin ? 20 : 3; // 20 untuk Login, 3 untuk Guest
            const ownerID = isLogin ? currentUser.uid : userIP;

            // Hitung jumlah link user ini
            let currentCount = 0;
            const snapshot = await db.ref('links').orderByChild('owner').equalTo(ownerID).once('value');
            if (snapshot.exists()) currentCount = Object.keys(snapshot.val()).length;

            if (currentCount >= maxLimit) {
                alert(`Kuota Habis! Anda sudah membuat ${currentCount}/${maxLimit} link. ${isLogin ? 'Hapus link lama.' : 'Login untuk dapat 20 link!'}`);
                return;
            }

            // Save to Firebase
            const linkData = {
                url: oriUrl,
                owner: ownerID,
                clicks: 0,
                limit: 10, // Default 10x per IP visitor
                password: pass || null,
                hint: hint || null,
                backupUrl: backup || null,
                created_at: Date.now()
            };

            await db.ref('links/' + alias).set(linkData);
            
            // UI Success
            document.getElementById('result-box').style.display = 'block';
            document.getElementById('final-link').innerText = window.location.href + '?' + alias;
            loadQuota(); // Refresh Quota
            if(isLogin) loadClientData(); // Refresh Table
        }

        // =========================================================
        // 4. DASHBOARD & ADMIN LOGIC
        // =========================================================

        async function loadQuota() {
            const isLogin = !!currentUser;
            const maxLimit = isLogin ? 20 : 3;
            const ownerID = isLogin ? (currentUser ? currentUser.uid : null) : userIP;

            if(!ownerID) return; // Wait init

            let count = 0;
            const snapshot = await db.ref('links').orderByChild('owner').equalTo(ownerID).once('value');
            if (snapshot.exists()) count = Object.keys(snapshot.val()).length;

            const percentage = (count / maxLimit) * 100;
            document.getElementById('quota-bar').style.width = percentage + "%";
            document.getElementById('quota-msg').innerText = `Kuota Terpakai: ${count} / ${maxLimit} Link`;
            
            // Color logic
            const bar = document.getElementById('quota-bar');
            if(percentage > 80) bar.style.background = "#ff4d4d";
            else bar.style.background = "#00ccff";
        }

        function loadClientData() {
            if(!currentUser) return;
            const tbody = document.getElementById('client-table').querySelector('tbody');
            tbody.innerHTML = "<tr><td colspan='4'>Memuat...</td></tr>";

            db.ref('links').orderByChild('owner').equalTo(currentUser.uid).on('value', snap => {
                tbody.innerHTML = "";
                if(!snap.exists()) { tbody.innerHTML = "<tr><td colspan='4'>Belum ada link.</td></tr>"; return; }
                
                snap.forEach(child => {
                    const data = child.val();
                    const key = child.key;
                    const fullLink = window.location.href.split('?')[0] + '?' + key;
                    
                    const row = `<tr>
                        <td><b>${key}</b></td>
                        <td>${data.clicks}</td>
                        <td>10x/IP</td>
                        <td>
                            <i class="fas fa-qrcode action-btn icon-qr" onclick="showQR('${fullLink}')"></i>
                            <i class="fas fa-trash action-btn icon-del" onclick="deleteLink('${key}')"></i>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }

        function loadAdminData() {
            const tbody = document.getElementById('admin-table').querySelector('tbody');
            db.ref('links').limitToLast(50).on('value', snap => {
                tbody.innerHTML = "";
                snap.forEach(child => {
                    const data = child.val();
                    const row = `<tr>
                        <td><small>${data.owner.substring(0,8)}...</small></td>
                        <td>${child.key}</td>
                        <td><small>${data.url.substring(0,20)}...</small></td>
                        <td><i class="fas fa-trash action-btn icon-del" onclick="deleteLink('${child.key}')"></i></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }

        function deleteLink(alias) {
            if(confirm("Hapus link ini permanen?")) {
                db.ref('links/' + alias).remove();
            }
        }

        function banIP() {
            const ip = document.getElementById('ban-ip-input').value.trim();
            if(ip) {
                const sanitized = sanitizeKey(ip);
                db.ref('banned_ips/' + sanitized).set(true);
                alert("IP Banned Permanently!");
            }
        }

        // =========================================================
        // 5. UTILS & AUTH
        // =========================================================

        function toggleAuth() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(e => alert(e.message));
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById('view-' + tabName).classList.add('active');
            // Button active state logic simplified for brevity
            if(tabName === 'create') document.querySelector('.tabs div:nth-child(1)').classList.add('active');
            if(tabName === 'dashboard') document.querySelector('.tabs div:nth-child(2)').classList.add('active');
            if(tabName === 'admin') document.querySelector('.tabs div:nth-child(3)').classList.add('active');
        }

        function showQR(text) {
            document.getElementById('qr-modal').style.display = 'flex';
            document.getElementById('qr-display').innerHTML = "";
            new QRCode(document.getElementById("qr-display"), {
                text: text,
                width: 200,
                height: 200
            });
        }

        function closeQR() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        function copyLink() {
            const text = document.getElementById('final-link').innerText;
            navigator.clipboard.writeText(text);
            alert("Link tersalin!");
        }

        // =========================================================
        // 6. LINK RESOLVER (THE ENGINE)
        // =========================================================
        
        async function resolveLink() {
            const params = window.location.search.substring(1);
            if (!params) return; // No link requested

            // Hide UI, Show Loading
            document.body.innerHTML = `
                <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:#00ff88;flex-direction:column;">
                    <h1><i class="fas fa-circle-notch fa-spin"></i> RifqyURL v10</h1>
                    <p>Memproses Keamanan...</p>
                </div>
            `;

            // 1. Check Link Exist
            const snapshot = await db.ref('links/' + params).once('value');
            if (!snapshot.exists()) {
                document.body.innerHTML = "<h2 style='color:white;text-align:center;'>404 - Link Tidak Ditemukan</h2>";
                return;
            }

            const data = snapshot.val();
            
            // 2. IP & Limit Check (The 10x Fix)
            const ipKey = userIP; // Already sanitized in init
            const visitorRef = db.ref(`visitors/${params}/${ipKey}`);
            
            const visitSnap = await visitorRef.once('value');
            let visitCount = visitSnap.exists() ? visitSnap.val() : 0;

            if (visitCount >= 10) {
                // Limit Reached -> Redirect Backup or Error
                if(data.backupUrl) {
                    window.location.href = data.backupUrl;
                } else {
                    document.body.innerHTML = "<h2 style='color:red;text-align:center;'>Limit Akses Anda (10x) Habis untuk link ini.</h2>";
                }
                return;
            }

            // 3. Password Check
            if (data.password) {
                let hintMsg = data.hint ? `<br><small style="color:yellow">Hint: ${data.hint}</small>` : "";
                let inputPass = prompt("Link ini terkunci Password." + (data.hint ? " (Hint: " + data.hint + ")" : ""));
                
                // Simple Prompt loop (bisa diganti UI modal kalo mau lebih keren, tapi prompt paling aman dari inspect)
                while (inputPass !== data.password) {
                    if(inputPass === null) return; // Cancel
                    inputPass = prompt("Password Salah! Coba lagi." + (data.hint ? "\nHint: " + data.hint : ""));
                }
            }

            // 4. Update Stats
            visitCount++;
            await visitorRef.set(visitCount);
            await db.ref(`links/${params}/clicks`).set(firebase.database.ServerValue.increment(1));

            // 5. Deep Link & Redirect
            // Cek apakah link YouTube/IG/Shopee
            let finalUrl = data.url;
            
            // Auto Deep Link Logic (Simple Intent)
            if (finalUrl.includes('youtube.com') || finalUrl.includes('youtu.be')) {
                // Try open app
                const appUrl = finalUrl.replace("https://", "vnd.youtube://");
                // Fallback handled by browser usually, but we redirect to http
            } 
            
            // Final Jump
            window.location.href = finalUrl;
        }

        // Start System
        initSystem().then(() => {
            // Check if user is opening a shortlink
            if(window.location.search.length > 1) {
                resolveLink();
            }
        });

    </script>
</body>
</html>
